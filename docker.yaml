---
- hosts: docker
  become: yes

  vars_files:
    - vars/main.yaml

  pre_tasks:
    - name: Ensure dependencies are installed
      pacman:
        update_cache: yes
        name:
          - rpcbind
          - nfs-utils
          - ntp
          - docker
          - python-pip
          - python-setuptools
          - python-virtualenv
          - keepalived
          - ipset

    - name: Ensure python docker library is installed
      pip:
        name: docker

    - name: Ensure ntpd daemon is started and enabled
      systemd:
        name: ntpd
        enabled: yes
        state: started

    - name: Ensure docker daemon is started and enabled
      systemd:
        name: docker
        enabled: yes
        state: started

  tasks:
    - name: Include prometheus node exporter
      include_tasks: shared_tasks/prometheus_node_exporter.yaml

    - name: Ensure docker user is created
      user:
        name: docker

    - name: Ensure that the docker volumes directory is created
      file:
        path: /home/docker/volumes
        state: directory
        owner: docker
        group: users

- hosts: docker01
  become: yes

  vars_files:
    - vars/main.yaml
    - vars/secrets.yaml

  handlers:
    - name: Restart Keepalived
      systemd:
        name: keepalived
        state: restarted

  tasks:
    - name: Ensure that the keepalived config is updated
      template:
        src: config/keepalived/docker01.j2
        dest: /etc/keepalived/keepalived.conf
      notify:
        - Restart Keepalived

    - name: Ensure keepalived daemon is started and enabled
      systemd:
        name: keepalived
        enabled: yes
        state: started

    - name: Ensure that the media NFS is mounted
      mount:
        src: 192.168.4.245:/volume1/k8s/media-server/plex/data/library
        path: /mnt/media
        opts: rw,sync,hard,nfsvers=4.1
        state: mounted
        fstype: nfs

    - name: Ensure that portainer data volume is created
      docker_volume:
        name: portainer_data

    - name: Ensure that portainer container is created
      docker_container:
        name: portainer
        image: portainer/portainer-ee:2.15.1
        restart_policy: always
        volumes:
          - "/var/run/docker.sock:/var/run/docker.sock"
        mounts:
          - source: portainer_data
            target: /data
        ports:
          - "8000:8000"
          - "9443:9443"

    - name: Ensure that the fileflows volume Data directory exists
      file:
        path: /home/docker/volumes/fileflows/Data
        state: directory
        owner: docker
        group: users

    - name: Ensure that the fileflows volume Logs directory exists
      file:
        path: /home/docker/volumes/fileflows/Logs
        state: directory
        owner: docker
        group: users

    - name: Ensure that the fileflows volume Temp directory exists
      file:
        path: /home/docker/volumes/fileflows/Temp
        state: directory
        owner: docker
        group: users

    - name: Ensure that the fileflows server docker container is running
      docker_container:
        name: fileflows01
        hostname: fileflows01
        image: "revenz/fileflows:{{ fileflows_tag }}"
        ports:
          - 5000:5000
        volumes:
          - /home/docker/volumes/fileflows/Data:/app/Data
          - /home/docker/volumes/fileflows/Logs:/app/Logs
          - /home/docker/volumes/fileflows/Temp:/app/Temp
          - /mnt/media:/mnt/media
        devices:
          - /dev/dri:/dev/dri
        restart_policy: unless-stopped

- hosts: docker02
  become: yes

  vars_files:
    - vars/main.yaml
    - vars/secrets.yaml

  handlers:
    - name: Restart Caddy
      docker_container:
        name: caddy
        state: started
        restart: yes

    - name: Restart Keepalived
      systemd:
        name: keepalived
        state: restarted

  tasks:
    - name: Ensure that the keepalived config is updated
      template:
        src: config/keepalived/docker02.j2
        dest: /etc/keepalived/keepalived.conf
      notify:
        - Restart Keepalived

    - name: Ensure keepalived daemon is started and enabled
      systemd:
        name: keepalived
        enabled: yes
        state: started

    - name: Ensure that reverse proxy docker network is created
      docker_network:
        name: reverse_proxy

    - name: Ensure that caddy data volume is created
      docker_volume:
        name: caddy_data

    - name: Ensure that caddy config volume is created
      docker_volume:
        name: caddy_config

    - name: Ensure caddyfile volume directory is created
      file:
        path: /home/docker/volumes/caddy
        state: directory
        owner: docker
        group: users

    - name: Ensure the caddyfile is up to date
      template:
        src: config/Caddyfile.j2
        dest: /home/docker/volumes/caddy/Caddyfile
      notify:
        - Restart Caddy

    - name: Ensure that caddy container is created
      docker_container:
        name: caddy
        image: bloveless/caddy:2.5.2-0.1.0
        restart_policy: always
        networks:
          - name: reverse_proxy
        volumes:
          - "/home/docker/volumes/caddy/Caddyfile:/etc/caddy/Caddyfile"
        mounts:
          - source: caddy_data
            target: /data
          - source: caddy_config
            target: /config
        ports:
          - "80:80"
          - "443:443"
          - "443:443/udp"
          - "8090:8090"

    - name: Ensure cloudflared container is created
      docker_container:
        name: cloudflared
        image: cloudflare/cloudflared:2022.10.0-amd64
        command: "tunnel --metrics 0.0.0.0:8099 run --token {{ cloudflared_key }}"
        restart_policy: always
        ports:
          - "8099:8099"
        networks:
          - name: reverse_proxy

    - name: Ensure that fenrus data volume is created
      docker_volume:
        name: fenrus_data

    - name: Ensure that fenrus images volume is created
      docker_volume:
        name: fenrus_images

    - name: Ensure that fenrus container is created
      docker_container:
        name: fenrus
        image: revenz/fenrus:latest
        pull: true
        restart_policy: always
        env:
          TZ: America/Los_Angeles
        mounts:
          - source: fenrus_data
            target: /app/data
          - source: fenrus_images
            target: /app/wwwroot/images
        ports:
          - "3000:3000"

- hosts: docker03
  become: yes

  vars_files:
    - vars/main.yaml
    - vars/secrets.yaml

  handlers:
    - name: Restart Keepalived
      systemd:
        name: keepalived
        state: restarted

  tasks:
    - name: Ensure that the keepalived config is updated
      template:
        src: config/keepalived/docker03.j2
        dest: /etc/keepalived/keepalived.conf
      notify:
        - Restart Keepalived

    - name: Ensure keepalived daemon is started and enabled
      systemd:
        name: keepalived
        enabled: yes
        state: started

    - name: Ensure that the media NFS is mounted
      mount:
        src: 192.168.4.245:/volume1/k8s/media-server/plex/data/library
        path: /mnt/media
        opts: rw,sync,hard,nfsvers=4.1
        state: mounted
        fstype: nfs

    - name: Ensure that tiddlywiki volume is created
      docker_volume:
        name: tiddlywiki

    - name: Ensure that tiddlywiki container is created
      docker_container:
        name: tiddlywiki
        image: bloveless/tiddlywiki:5.2.3-0.1.0
        restart_policy: always
        mounts:
          - source: tiddlywiki
            target: /tiddlywiki
        ports:
          - "8080:8080"

    - name: Ensure that the fileflows volume Data directory exists
      file:
        path: /home/docker/volumes/fileflows/Data
        state: directory
        owner: docker
        group: users

    - name: Ensure that the fileflows volume Logs directory exists
      file:
        path: /home/docker/volumes/fileflows/Logs
        state: directory
        owner: docker
        group: users

    - name: Ensure that the fileflows volume Temp directory exists
      file:
        path: /home/docker/volumes/fileflows/Temp
        state: directory
        owner: docker
        group: users

    - name: Ensure that the fileflows node docker container is running
      docker_container:
        name: fileflows02
        hostname: fileflows02
        image: "revenz/fileflows:{{ fileflows_tag }}"
        env:
          FFNODE: "1"
          ServerUrl: "http://{{ fileflows_server_address }}"
        ports:
          - 5000:5000
        volumes:
          - /home/docker/volumes/fileflows/Data:/app/Data
          - /home/docker/volumes/fileflows/Logs:/app/Logs
          - /home/docker/volumes/fileflows/Temp:/app/Temp
          - /mnt/media:/mnt/media
        devices:
          - /dev/dri:/dev/dri
        restart_policy: unless-stopped

    - name: Ensure that homelab exporter container is running
      docker_container:
        name: homelab-exporter
        image: bloveless/homelab-exporter:0.1.0
        ports:
          - 2112:8080
        restart_policy: unless-stopped

